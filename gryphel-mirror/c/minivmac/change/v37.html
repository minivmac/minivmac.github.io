<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"><html lang="en"><head><title> Changes in Mini vMac 37 </title><meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="v37.html"></head><body><div><i> <a href="../../../index.html">www.gryphel.com</a>/c/<a href="../index.html">minivmac</a>/<a href="index.html">change</a>/v37- <a href="../../feedback.html">feedback</a> </i></div><hr><h3 align=center>	Mini vMac 37 <!-- *<i>Beta</i>* --></h3><h3 align=center>	Changes</h3><hr><p> What has changed in Mini vMac 37.00, compared to Mini vMac 36.04.This only lists changes that affect behavior, and so doesn'tinclude cleanups of the source code. </p><p> : </p><p>default compile:</p><blockquote><p><a href="v37.html#feature">New features</a></p><p><a href="v37.html#modified">Changed behavior</a></p><p><a href="v37.html#bugs">Bug fixes</a></p></blockquote><p>not in default compile:</p><blockquote><p><a href="v37.html#compile_feature">New features</a></p><p><a href="v37.html#compile_modified">Changed behavior</a></p><p><a href="v37.html#compile_bugs">Bug fixes</a></p></blockquote><p><a href="v37.html#build">Build System</a></p><p> : </p><p> <a name="feature"> <b> New features in default compile </b> </a> </p><!-- A new feature is something you would not notice if you usedMini vMac as you used it previously. If using it as you would previouslywould behave differently, that is "changed behavior". --><!--<p> * None Yet. </p>--><p> *A new target is added:</p><blockquote><p><a href="../options.html#option_t">-t mcar</a> { Macintosh OS X - ARM (Apple Silicon) }</p></p></blockquote><p> <a name="modified"> <b> Changed behavior in default compile </b> </a> </p><!--<p> * None Yet. </p>--><p> *Mini vMac will now check if a disk image that is beingmounted looks like a Macintosh disk image format (HFS or MFS), andif not decline to mount it, showing an error message. This helpsprevent accidentally corrupting other files, especially when usingImportFl.</p><p>But there are some other disk image formats that you might want tomount, such as Fat16 and ISO (which can be used by the emulatedMacintosh with additional software). Or, you may be trying to createyour own new disk image and want the emulated Macintosh to initialize it.In these cases you can use a version of Mini vMac compiled with the new&ldquo;<a href="../options.html#option_ndp">-ndp 0</a>&rdquo;option to turn off this protection.</p><p>If a Branch option prior to 37is chosen for compatibility with an earlier version,the default is &ldquo;-ndp 0&rdquo;, and you canuse &ldquo;-ndp 1&rdquo; to turn on this protection.</p><p> *The emulation of VIA timer 2, used for playing sound, has beenmodified when running at greater than 1x speed. There is no correctbehavior in this case, it is just a matter of picking what hasthe best compatibility with the greatest number of programs. Thischange fixes a<a href="../../mail/v10.html#m224">reported</a>issue with HyperCard, as well as playing alert sounds in theSound control panel, and the "Try Scale With Sound" command ofResEdit. However it also no longer passes theClock/Interrupt Test of MacCheck. Which seems a good trade off,unless further issues are found. (A program to test hardware*should* notice that something is strange when run at greaterthan 1x speed.) The specific change made is thattimer 2 now continues to run during extra cycles only for theduration of a short timer interval, rather than continuing to runin this case until the end of the extra cycles. (Normally, thetimer is paused for the extra cycles.)</p><p> <a name="bugs"> <b> Bug fixes in default compile </b> </a> </p><!--<p> * None Yet. </p>--><p> *The program Winter Games by Epyx would not work in Mini vMac. Thanks toJesus A. Alvarez (&ldquo;zydeco&rdquo;, author of the iOS port) forfiguring out why, and providing a<a href="../../mail/v12.html#m269">patch to Mini vMac</a> to fix it.The game directly modifies the VBL queue data structure of the Macintoshoperating system to add a VBL task, instead of calling the operatingsystem routine VInstall, but doesn&rsquo;t account for the possibilityof the queue being empty. The fix is to have the Mini vMac replacementdisk driver add a VBL task at boot, as the original disk driver does,so that the VBL queue is not empty.</p><p> *If the ROM image file that Mini vMac finds is not the desired ROM, buta different valid Macintish ROM that has been renamed, and the undesiredROM is larger than the desired ROM, Mini vMac would display a&ldquo;ROM checksum failed&rdquo; message instead of the&ldquo;Unsupported ROM&rdquo; message. This is because Mini vMacloads and  computes the checksum of the expected number of bytes,rather than the actual ROM image  size. (It is intended behavior thatMini vMac will work if the ROM image file has some extra junk at theend.) Mini vMac now checks that the checksumfield at the start of the ROM is recognized, before verifying theactual checksum. Thanks to a<a href="../../mail/v12.html#m271">bug report</a>for pointing out this issue.</p><p> *In Linux (and other ports using X11), if two keys on the keyboardare configured to act the same way (such as if the caps lock key hasbeen made to act as an additional control key), Mini vMac wouldonly recognize one of the keys. Thanks to Adrian Carpenter for<a href="../../mail/v11.html#m266">reporting</a> this issue,and providing a patch to fix it.</p><p> <a name="compile_feature"> <b> New features not in default compile </b> </a> </p><!--<p> * None Yet. </p>--><p> *A consequence of the merge of SDL 1.2 and SDL 2.0 code is thatthe &ldquo;-d&rdquo; and &ldquo;-n&rdquo; command line argumentsnow work for SDL 1.2 too.</p><p> <a name="compile_modified"> <b> Changed behavior not in default compile </b> </a> </p><!--<p> * None Yet. </p>--><p> *The new&ldquo;<a href="../options.html#option_lto">-lto</a>&rdquo;option provides alternative transport for LocalTalk emulation.In addition to Mike Fort&rsquo;s original code for LocalTalkover BPF (Berkeley Packet Filter), there is new code fromRob Mitchelmore for LocalTalk over UPD (User Datagram Protocol),that does not require setup or administrative privileges.The new UPD option is now the default for branch 37. If a prior&ldquo;-br&rdquo; (Branch) option is chosen for compatibility with anearlier version, the default is BPF.</p><p> *In response to this <a href="../../mail/v10.html#m221">report</a>,AutoSlow is now enabled by default for Macintosh II emulation,matching the default for emulation other Macintosh models. To try tomake this work properly, for Macintosh II emulation it now waits 60ticks rather 34 ticks for AutoSlow to activate.</p><p> <a name="compile_bugs"> <b> Bug fixes not in default compile </b> </a> </p><!--<p> * None Yet. </p>--><p> *The emulation of the BFINS instruction in the Macintosh IIincorrectly handled condition codes, causing an issue withthe game &ldquo;Dungeon Master 2&rdquo;. The N and Z flags shouldbe set from the new value, instead of the old value, unlikethe BFSET, BFCLR, and BFCHG bitfield instructions.Thanks to Christophe for<a href="../../mail/v10.html#m223">this fix</a>, adaptedfrom the same fix in WinUAE. (Some of the CPU emulation codeof Mini vMac descends from UAE.)</p><p> *When compiled with a recent version XCode, like 11.4.1,Mini vMac for OS X would not draw correctly on a retina display.It now calls&ldquo;setWantsBestResolutionOpenGLSurface:NO&rdquo; whenavailable. A comment found in SDL 2.0.12 explains:&ldquo;Note: as of the macOS 10.15 SDK, this defaults to YESinstead of NO when the NSHighResolutionCapable booleanis set in Info.plist&rdquo;. This problem occurred becausethe NSHighResolutionCapable key was added in July 2018 to make thewindow frame look better on retina screens.</p><p> *When compiled with a recent version XCode, like 11.4.1,Mini vMac for OS X would do a lot of excess drawing.Every time lockFocus/unlockFocuswas called to draw to the window, a call to drawRect got triggeredfor the entire window. Research indicates that lockFocus/unlockFocusare deprecated, you are never supposed to draw outside ofdrawRect, and only notify the OS what needs to be drawn. SoI tried that, using setNeedsDisplayInRect. No matter what rectangleis passed, drawRect still draws the entire window. It is hard tobelieve macOS is really that broken. Probably there is somethingelse about what Mini vMac is doing to make the operating systemunhappy. But I don&rsquo;t know what. Before giving up for now,I tried simply removing the lockFocus/unlockFocus, and that seemsto work fine. It doesn&rsquo;t seem correct, but themain thing it is supposed to do is set the drawing context,and Mini vMac is already calling makeCurrentContext with the OpenGLcontext. So I&rsquo;ve left it like that for now.</p><p> *The built in disassembler(enabled with &ldquo;<a href="../develop.html#option_d">-dis 1</a>&rdquo;)incorrectly handled the BCHG/BCLR/BSET/BTST instructions.Thanks to Ryan for<a href="../../mail/v10.html#m180">this fix</a>.</p><p> *If Mini vMac for some reason is attempting to display a new messageoverlay on every tick(the kind that says &ldquo;Type C to continue&rdquo;), the messagewould never appear.</p><p> *Mini vMac would fail to compile with the options&ldquo;-m II -em-cpu 0&rdquo; (Macintosh II emulation with 68000CPU). This is fixed. However, these options still do not work,because the Mac II ROM does not work on a 68000. So in addition,the Mini vMac compile setup code now gives an error message for theseoptions.</p><p> <a name="build"> <b> Build System </b> </a> </p> <!--<p> * None Yet. </p>--><p> *All of the options for the configuration tool that could be definedin &ldquo;setup/CONFIGUR.i&rdquo; have been removed and replaced with<a href="../develop.html">developer options</a>to the configuration tool.This includes:<a href="../develop.html#option_maintainer">Maintainer Name</a>,<a href="../develop.html#option_homepage">Home Page</a>,<a href="../develop.html#option_e">Development Environment</a>,<a href="../develop.html#option_ev">Development Environment Version</a>,<a href="../develop.html#option_cl">Use Command Line</a>,<a href="../develop.html#option_scr">Scripting Language</a>,<a href="../develop.html#option_l">Print File List</a>,<a href="../develop.html#option_pvo">Print Variation Name</a>, and<a href="../develop.html#option_pvn">Print Variation Options</a>.</p><p> *In response to <a href="https://www.gryphel.com/c/minivmac/change/c/mail/v11.html#m234">suggestions</a>by Tara Keeling for making it easier to port Mini vMac,the source code for the SDL 1.2 and SDL 2.0 portsare merged into one file. Then SDL has been made the "referenceimplementation", containing comments that apply to all the ports.From Mini vMac version 2.8.0 up to (but not including) version 3.2.0,there was a &ldquo;gen&rdquo; (generic) reference port intendedto provide a skeleton for porting to new platforms. But since itwasn&rsquo;t normally used, it tended to get out of date, and so wasremoved. Instead the comments were moved to the classic Macintosh port,chosen as being neutral between modern platforms. But these days,SDL is a much more practical starting point for porting.After you get it working with SDL, if you want a more native port,you can merge the source of SDL and Mini vMac, and then step bystep clean it up, until almost nothing of SDL remains. The Cocoaport was made way, with no prior knowledge of Cocoa or Objective-C.This technique takes a while but is straightforward.</p><p>The SDL port has been further modified so that if it is compiledwithout including the SDL headers, it will not use SDL, only standardC libraries. Just as the &ldquo;gen&rdquo; port used to. This minimalport actually functions, even without screen, keyboard, or mouseemulation. If you prepare a disk with AutoQuit and CopyRoms,it will run and quit, saving a ROM image. Whichtests that most of Mini vMac functions, and now you just needto implement the platform specific parts. Which is an alternativeapproach for target platforms where SDL is not available, or for peoplefamiliar with their target platform who don&rsquo;t want to fuss withSDL.</p><p> * The build system has a new target option,&ldquo;<a href="../develop.html#option_t">-t port</a>&rdquo;,in which configuration files are not generated for the platform andcompiler. This allows for ports of Mini vMac not supported by thesetup tool to still use the setup tool for user Variations,by providing these files.</p><p> * The build system has a new option,&ldquo;<a href="../develop.html#option_af">-af</a>&rdquo;.The configuration tool normally arranges that only source files neededfor the current user options are compiled. This option causes allfiles to be compiled, which works because the source files themselvescontain preprocessor conditionals to skip the unwanted code.This option also causes inclusion of all API header files andlink libraries that could be needed for any set of user options,rather than only what is needed for the current user options.</p><p>This option can be useful when creating an external port based offa supported configuration. The files of an external port needto work for any set of user options.</p><p> *The build system now supports Xcode 12.3(with &ldquo;<a href="../develop.html#option_ev">-ev 12300</a>&rdquo;),and also 12.1 (&ldquo;-ev 12100&rdquo;).</p><p> * The build system now supports Microsoft Visual Studio 2019(with &ldquo;<a href="../develop.html#option_ev">-ev 16000</a>&rdquo;).</p><p> *The build system option&ldquo;<a href="../develop.html#option_cpu">-cpu</a>&rdquo;now accepts another cpu: &ldquo;-cpu a64&rdquo;, for ARM 64,such as Apple Silicon.</p><p> *The build system now rejects Target options(&ldquo;<a href="../develop.html#option_t">-t</a>&rdquo;)that are not officially supported, for official builds.</p><p> : </p><p> If you find Mini vMac useful, please consider<a href="../../help/index.html">helping the Gryphel Project</A>,of which it is a part. </p><a href="../../../index.html"><img src="../../../d/gryphel-32.gif" width=32 height=32 border=0	alt="gryphel logo, 1K"></a><p> Back up to - <b><a href="index.html">Changes in Mini vMac versions</a></b></p><hr><div><i> <a href="../../../index.html">www.gryphel.com</a>/c/<a href="../index.html">minivmac</a>/<a href="index.html">change</a>/v37- <a href="../../feedback.html">feedback</a> </i><br>copyright (c) 2020 Paul C. Pratt - last update 12/9/2020</div></body></html>